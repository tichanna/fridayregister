const SHEET_NAME = "Sheet1";
const HEADERS = ["Date", "Name", "Surname", "Research Topic", "Supervisor", "Email"];
const FRIDAY_DATES = [
  "01-08-2025", "08-08-2025", "15-08-2025", "22-08-2025", "29-08-2025",
  "05-09-2025", "12-09-2025", "19-09-2025", "26-09-2025",
  "03-10-2025", "10-10-2025", "17-10-2025", "24-10-2025"
];

function doGet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();

  const bookedDates = new Set();
  const usedEmails = new Set();

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const date = row[0];
    const email = row[5];
    if (date && date.trim() !== "") bookedDates.add(date.trim());
    if (email && email.trim() !== "") usedEmails.add(email.trim().toLowerCase());
  }

  const availableDates = FRIDAY_DATES
    .filter(date => !bookedDates.has(date))
    .map(date => ({ date }));

  return ContentService
    .createTextOutput(JSON.stringify(availableDates))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const params = e.parameter;
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();

  const date = params.date;
  const name = params.name;
  const surname = params.surname;
  const topic = params.topic;
  const supervisor = params.supervisor;
  const email = params.email.toLowerCase();

  const bookedDates = new Set();
  const usedEmails = new Set();

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[0] && row[0].trim() !== "") bookedDates.add(row[0].trim());
    if (row[5] && row[5].trim() !== "") usedEmails.add(row[5].trim().toLowerCase());
  }

  if (bookedDates.has(date)) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: `Date ${date} is already booked.`
    })).setMimeType(ContentService.MimeType.JSON);
  }

  if (usedEmails.has(email)) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: `Email ${email} has already booked.`
    })).setMimeType(ContentService.MimeType.JSON);
  }

  sheet.appendRow([date, name, surname, topic, supervisor, email]);

  MailApp.sendEmail({
    to: email,
    subject: "Research Friday Booking Confirmation",
    htmlBody: `
      <p>Dear ${name} ${surname},</p>
      <p>Your booking for <strong>${date}</strong> has been confirmed.</p>
      <p><strong>Topic:</strong> ${topic}<br>
         <strong>Supervisor:</strong> ${supervisor}</p>
      <p>Thank you.</p>`
  });

  return ContentService.createTextOutput(JSON.stringify({
    success: true
  })).setMimeType(ContentService.MimeType.JSON);
}
